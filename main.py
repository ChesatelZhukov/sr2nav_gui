#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
–¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ SR2NAV Studio.

–û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ –¥–≤—É—Ö —Ä–µ–∂–∏–º–∞—Ö:
    1. –†–µ–∂–∏–º —Å–∫—Ä–∏–ø—Ç–∞ (python main.py)
    2. –°–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π EXE (—Å–æ–∑–¥–∞–Ω–Ω—ã–π PyInstaller)

–û—Å–Ω–æ–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏:
    - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—É—Ç–µ–π –∏–º–ø–æ—Ä—Ç–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã –≤ –æ–±–æ–∏—Ö —Ä–µ–∂–∏–º–∞—Ö
    - –°–∫—Ä—ã—Ç–∏–µ –∫–æ–Ω—Å–æ–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –≤ Windows (–¥–ª—è GUI-–≤–µ—Ä—Å–∏–∏)
    - –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –∫–æ–Ω—Å–æ–ª–∏
    - –ò–º–ø–æ—Ä—Ç –∏ –∑–∞–ø—É—Å–∫ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    - –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∑–∞–ø—É—Å–∫–µ

–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã:
    - –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø–µ—Ä–µ–¥ –Ω–∞—Å—Ç—Ä–æ–π–∫–æ–π –ø—É—Ç–µ–π
    - –£—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∫ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—é –∫–æ–Ω—Å–æ–ª–∏ (safe_print)
    - –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –Ω–∞ –≤—Å–µ—Ö —ç—Ç–∞–ø–∞—Ö
    - –ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –¥–ª—è –≤—Å–µ—Ö —Ä–µ–∂–∏–º–æ–≤ –∑–∞–ø—É—Å–∫–∞
"""
import sys
import os
from pathlib import Path

def hide_console() -> None:
    """
    –°–∫—Ä—ã–≤–∞–µ—Ç –∫–æ–Ω—Å–æ–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ GUI –≤ Windows.
    
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ:
        - –ù–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ Windows
        - –í —Ä–µ–∂–∏–º–µ —Å–∫—Ä–∏–ø—Ç–∞ (–Ω–µ frozen)
    
    –ê–ª–≥–æ—Ä–∏—Ç–º:
        1. –ü–æ–ª—É—á–∞–µ—Ç –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä –∫–æ–Ω—Å–æ–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —á–µ—Ä–µ–∑ kernel32.GetConsoleWindow()
        2. –ï—Å–ª–∏ –∫–æ–Ω—Å–æ–ª—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —Å–∫—Ä—ã–≤–∞–µ—Ç –µ—ë —á–µ—Ä–µ–∑ ShowWindow(0)
    
    –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:
        - –ò–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç –≤—Å–µ –æ—à–∏–±–∫–∏ (–∫–æ–Ω—Å–æ–ª—å –º–æ–∂–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å)
        - –ù–µ –≤–ª–∏—è–µ—Ç –Ω–∞ —Ä–∞–±–æ—Ç—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø—Ä–∏ –Ω–µ—É–¥–∞—á–µ
        - –î–ª—è —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ EXE –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è (—Ç–∞–º –∫–æ–Ω—Å–æ–ª—å —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Ñ–ª–∞–≥–∞–º–∏ PyInstaller)
    """
    if sys.platform == 'win32' and not getattr(sys, 'frozen', False):
        try:
            import ctypes
            kernel32 = ctypes.WinDLL('kernel32', use_last_error=True)
            user32 = ctypes.WinDLL('user32', use_last_error=True)
            hwnd = kernel32.GetConsoleWindow()
            if hwnd:
                user32.ShowWindow(hwnd, 0)  # 0 = SW_HIDE
        except Exception:
            pass  # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ —Å–∫—Ä—ã—Ç–∏—è –∫–æ–Ω—Å–æ–ª–∏


def setup_python_path() -> None:
    """
    –î–æ–±–∞–≤–ª—è–µ—Ç –∫–æ—Ä–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –≤ sys.path –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞.
    
    –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ –¥–ª—è —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ EXE, —Ç–∞–∫ –∫–∞–∫ PyInstaller
    –º–æ–∂–µ—Ç –Ω–µ –≤–∫–ª—é—á–∏—Ç—å –∫–æ—Ä–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –≤ –ø—É—Ç–∏ –ø–æ–∏—Å–∫–∞ –º–æ–¥—É–ª–µ–π.
    
    –ê–ª–≥–æ—Ä–∏—Ç–º:
        1. –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é, –≥–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —ç—Ç–æ—Ç —Ñ–∞–π–ª
        2. –î–æ–±–∞–≤–ª—è–µ—Ç –µ—ë –≤ –Ω–∞—á–∞–ª–æ sys.path (–µ—Å–ª–∏ –µ—â—ë –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞)
    
    –ü–æ—á–µ–º—É —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:
        - –í —Ä–µ–∂–∏–º–µ —Å–∫—Ä–∏–ø—Ç–∞: —Ñ–∞–π–ª main.py –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞
        - –í —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–º EXE: —Ñ–∞–π–ª –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
          –≤–º–µ—Å—Ç–µ —Å–æ –≤—Å–µ–º–∏ –º–æ–¥—É–ª—è–º–∏
    
    –í–∞–∂–Ω–æ:
        –î–æ–ª–∂–Ω–∞ –≤—ã–∑—ã–≤–∞—Ç—å—Å—è –î–û –ª—é–±—ã—Ö –∏–º–ø–æ—Ä—Ç–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞.
    """
    current_dir = Path(__file__).parent.absolute()
    if str(current_dir) not in sys.path:
        sys.path.insert(0, str(current_dir))


def safe_print(*args, **kwargs) -> None:
    """
    –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –≤—ã–≤–æ–¥ –≤ –∫–æ–Ω—Å–æ–ª—å, –Ω–µ –≤—ã–∑—ã–≤–∞—é—â–∏–π –æ—à–∏–±–æ–∫ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ stdout.
    
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≤—ã–≤–æ–¥–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∑–∞–ø—É—Å–∫–µ, –Ω–æ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç –æ—à–∏–±–∫–∏,
    –µ—Å–ª–∏ –∫–æ–Ω—Å–æ–ª—å —Å–∫—Ä—ã—Ç–∞, –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∞.
    
    Args:
        *args, **kwargs: –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã print()
    
    Note:
        - –ü—Ä–∏ –æ—à–∏–±–∫–µ –≤—ã–≤–æ–¥–∞ (IOError, OSError, AttributeError) –º–æ–ª—á–∞ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç
        - –ü–æ–ª–µ–∑–Ω–æ –¥–ª—è GUI-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π, –≥–¥–µ –∫–æ–Ω—Å–æ–ª—å –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–∫—Ä—ã—Ç–∞
    """
    try:
        print(*args, **kwargs)
    except (IOError, OSError, AttributeError):
        pass  # –ö–æ–Ω—Å–æ–ª—å –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–∫—Ä—ã—Ç–∞ –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å


def main() -> None:
    """
    –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
    
    –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–µ–π—Å—Ç–≤–∏–π:
        1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—É—Ç–µ–π –∏–º–ø–æ—Ä—Ç–∞ (setup_python_path)
        2. –°–∫—Ä—ã—Ç–∏–µ –∫–æ–Ω—Å–æ–ª–∏ (hide_console) - —Ç–æ–ª—å–∫–æ –¥–ª—è Windows
        3. –ò–º–ø–æ—Ä—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (core.app_context)
        4. –í—ã–≤–æ–¥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∑–∞–ø—É—Å–∫–µ (safe_print)
        5. –ò–º–ø–æ—Ä—Ç –∏ –∑–∞–ø—É—Å–∫ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞
        6. –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫
    
    –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:
        - ImportError: –ø—Ä–æ–±–ª–µ–º–∞ —Å –∏–º–ø–æ—Ä—Ç–æ–º –º–æ–¥—É–ª–µ–π (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—É—Ç–∏)
        - KeyboardInterrupt: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–µ—Ä–≤–∞–ª –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
        - Exception: –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏
    
    –í —Å–ª—É—á–∞–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –æ—à–∏–±–∫–∏ –ø—ã—Ç–∞–µ—Ç—Å—è:
        1. –í—ã–≤–µ—Å—Ç–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –∫–æ–Ω—Å–æ–ª—å
        2. –ü–æ–∫–∞–∑–∞—Ç—å –¥–∏–∞–ª–æ–≥–æ–≤–æ–µ –æ–∫–Ω–æ —Å –æ—à–∏–±–∫–æ–π (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω tkinter)
        3. –î–æ–∂–¥–∞—Ç—å—Å—è –Ω–∞–∂–∞—Ç–∏—è Enter –¥–ª—è –≤—ã—Ö–æ–¥–∞
    """
    # –®–∞–≥ 1: –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø—É—Ç–∏ –î–û –ª—é–±—ã—Ö –∏–º–ø–æ—Ä—Ç–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞
    setup_python_path()
    
    # –®–∞–≥ 2: –°–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Å–æ–ª—å (—Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—É—Ç–µ–π)
    hide_console()
    
    # –®–∞–≥ 3: –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—É—Ç—è—Ö
    try:
        from core.app_context import APP_CONTEXT
    except ImportError as e:
        safe_print(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: {e}")
        safe_print(f"üìÅ –¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: {Path(__file__).parent}")
        safe_print(f"üìÅ sys.path: {sys.path}")
        input("–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –≤—ã—Ö–æ–¥–∞...")
        sys.exit(1)
    
    # –®–∞–≥ 4: –í—ã–≤–æ–¥–∏–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–ø—É—Å–∫–µ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –∫–æ–Ω—Å–æ–ª—å)
    try:
        safe_print("=" * 60)
        safe_print("üöÄ SR2NAV Studio v2.0.0")
        safe_print("=" * 60)
        safe_print(f"üìÅ –†–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: {APP_CONTEXT.working_dir}")
        safe_print(f"üìÅ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã: {APP_CONTEXT.results_dir}")
        safe_print(f"üìÅ TBL —Ñ–∞–π–ª—ã: {APP_CONTEXT.tbl_dir}")
        safe_print("=" * 60)
        safe_print()
    except Exception:
        pass  # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –≤—ã–≤–æ–¥–∞
    
    # –®–∞–≥ 5: –ó–∞–ø—É—Å–∫ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    try:
        from controller.app_controller import ApplicationController
        
        app = ApplicationController()
        app.run()
        
    except KeyboardInterrupt:
        safe_print("\nüëã –ü—Ä–æ–≥—Ä–∞–º–º–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
        sys.exit(0)
        
    except Exception as e:
        safe_print(f"\n‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
        import traceback
        traceback.print_exc()
        
        # –®–∞–≥ 6: –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É –≤ GUI-–¥–∏–∞–ª–æ–≥–µ
        try:
            import tkinter as tk
            from tkinter import messagebox
            
            root = tk.Tk()
            root.withdraw()
            messagebox.showerror(
                "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞",
                f"–ü—Ä–æ–≥—Ä–∞–º–º–∞ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –æ—à–∏–±–∫–æ–π:\n\n{str(e)}\n\n"
                f"–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏."
            )
            root.destroy()
        except Exception:
            # –ï—Å–ª–∏ tkinter –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∂–¥—ë–º –≤–≤–æ–¥–∞ –≤ –∫–æ–Ω—Å–æ–ª–∏
            input("\n–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –≤—ã—Ö–æ–¥–∞...")
        
        sys.exit(1)


if __name__ == "__main__":
    main()
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Утилиты для сохранения состояния пользовательского интерфейса между сессиями.

Обеспечивает персистентность данных UI, таких как последняя выбранная папка,
чтобы при повторных открытиях диалогов пользователь возвращался в то же место.

Архитектурные принципы:
    - Класс-синглтон с класс-методами (не требует инстанцирования)
    - Не имеет зависимостей от других компонентов
    - Работает с файловой системой только для проверки существования путей
    - Учитывает особенности Windows (длинные пути >260 символов)

На текущий момент хранит:
    - Последнюю использованную директорию для диалогов открытия/сохранения

В будущем может быть расширен для сохранения:
    - Размера и положения окон
    - Последних выбранных настроек
    - Состояния сворачиваемых панелей
"""
import os
import sys
from typing import Optional


class UIPersistence:
    """
    Хранилище состояния пользовательского интерфейса.
    
    Использует класс-методы для глобального доступа без необходимости
    создавать экземпляр. Все данные хранятся в класс-атрибутах.
    
    Пример использования:
        >>> # Сохранение после выбора файла
        >>> UIPersistence.set_last_dir("/home/user/data/file.txt")
        >>> 
        >>> # Восстановление при следующем открытии диалога
        >>> initial_dir = UIPersistence.get_last_dir()
        >>> if initial_dir:
        ...     filedialog.askdirectory(initialdir=initial_dir)
    
    Особенности:
        - Для Windows автоматически добавляет префикс '\\\\?\\' для длинных путей
        - Проверяет существование путей перед сохранением
        - Из пути к файлу извлекает директорию
    """
    
    _last_browse_dir: str = ""
    """Последняя использованная директория для диалогов открытия/сохранения."""
    
    @classmethod
    def get_last_dir(cls) -> str:
        """
        Возвращает последнюю использованную директорию.
        
        Returns:
            Путь к последней директории или пустая строка, если ещё не было выбора.
        """
        return cls._last_browse_dir
    
    @classmethod
    def set_last_dir(cls, path: str) -> None:
        """
        Сохраняет последнюю использованную директорию.
        
        Принимает как путь к файлу, так и путь к директории.
        Автоматически извлекает директорию из пути к файлу.
        
        Args:
            path: Путь к файлу или директории, который был выбран пользователем.
                 Может быть пустым (тогда ничего не сохраняется).
        
        Note:
            Для Windows путей длиннее 240 символов добавляется префикс '\\\\?\\',
            чтобы обойти ограничение MAX_PATH в стандартных API Windows.
        """
        if not path:
            return
        
        # Для Windows путей длиннее 240 символов используем длинный путь
        if sys.platform == 'win32' and len(path) > 240:
            path = '\\\\?\\' + path
        
        # Извлекаем директорию, если передан путь к файлу
        dir_path = os.path.dirname(path) if os.path.isfile(path) else path
        
        # Сохраняем только если директория существует
        if dir_path and os.path.exists(dir_path):
            cls._last_browse_dir = dir_path
    
    @classmethod
    def update_from_path(cls, path: str) -> None:
        """
        Обновляет последнюю директорию из пути к файлу.
        
        Упрощённый метод-обёртка над set_last_dir для случаев,
        когда точно известно, что передан путь к файлу.
        
        Args:
            path: Путь к файлу, выбранному пользователем.
        """
        if path and os.path.exists(path):
            cls._last_browse_dir = os.path.dirname(path)
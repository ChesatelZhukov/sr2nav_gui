#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
–£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –≤—Å–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

–û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –µ–¥–∏–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ–±–º–µ–Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –º–µ–∂–¥—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏:
Backend -> Controller -> Frontend —á–µ—Ä–µ–∑ –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω—É—é –æ—á–µ—Ä–µ–¥—å.

–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:
    - –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –º–æ–¥–µ–ª–∏ —Å–æ–∑–¥–∞—é—Ç —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ —Ñ–∞–±—Ä–∏—á–Ω—ã–µ –º–µ—Ç–æ–¥—ã (info, warning, etc.)
    - –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –ø—É–±–ª–∏–∫—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –æ—á–µ—Ä–µ–¥—å
    - –ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —á–∏—Ç–∞–µ—Ç –∏–∑ –æ—á–µ—Ä–µ–¥–∏ –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –≤ –ª–æ–≥–µ –∏ –≤—Å–ø–ª—ã–≤–∞—é—â–∏—Ö –æ–∫–Ω–∞—Ö

–ü—Ä–∏–º–µ—Ä –ø–æ—Ç–æ–∫–∞ –¥–∞–Ω–Ω—ã—Ö:
    model.some_method() -> self._publish_message(AppMessage.info("–ì–æ—Ç–æ–≤–æ")) ->
    message_queue -> MainWindow._process_messages() -> –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –ª–æ–≥–µ

–£—Ä–æ–≤–Ω–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç –≤–∏–∑—É–∞–ª—å–Ω–æ–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∏ –ø–æ–≤–µ–¥–µ–Ω–∏–µ (popup/–Ω–µ popup).
"""
from dataclasses import dataclass
from enum import Enum, auto
from typing import Optional
from datetime import datetime


class MessageLevel(Enum):
    """
    –£—Ä–æ–≤–Ω–∏ —Å–æ–æ–±—â–µ–Ω–∏–π —Å –≤–∏–∑—É–∞–ª—å–Ω—ã–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º –∏ –ø—Ä–∞–≤–∏–ª–∞–º–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.
    
    –ö–∞–∂–¥—ã–π —É—Ä–æ–≤–µ–Ω—å –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç:
        - –ü—Ä–µ—Ñ–∏–∫—Å –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –ª–æ–≥–µ (—Å —ç–º–æ–¥–∑–∏)
        - –ù—É–∂–Ω–æ –ª–∏ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ –æ–∫–Ω–æ (should_popup)
        - CSS-–ø–æ–¥–æ–±–Ω—ã–π —Ç–µ–≥ –¥–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –≤ Tkinter Text –≤–∏–¥–∂–µ—Ç–µ
    """
    DEBUG = auto()
    INFO = auto()
    SUCCESS = auto()   # –î–ª—è —è–≤–Ω–æ–≥–æ –æ–±–æ–∑–Ω–∞—á–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π
    WARNING = auto()
    ERROR = auto()
    
    @property
    def prefix(self) -> str:
        """
        –ü—Ä–µ—Ñ–∏–∫—Å —Å —ç–º–æ–¥–∑–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –∫–æ–Ω—Å–æ–ª—å–Ω–æ–º –ª–æ–≥–µ –∏ UI.
        
        Returns:
            str: –ü—Ä–µ—Ñ–∏–∫—Å –≤–∏–¥–∞ "‚úÖ SUCCESS" –∏–ª–∏ "‚ùå ERROR"
        """
        return {
            MessageLevel.DEBUG: "üêõ DEBUG",
            MessageLevel.INFO: "‚ÑπÔ∏è INFO",
            MessageLevel.SUCCESS: "‚úÖ SUCCESS",
            MessageLevel.WARNING: "‚ö†Ô∏è WARNING",
            MessageLevel.ERROR: "‚ùå ERROR",
        }[self]
    
    @property
    def should_popup(self) -> bool:
        """
        –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –¥–æ–ª–∂–Ω–æ –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤—ã–∑—ã–≤–∞—Ç—å –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ –æ–∫–Ω–æ.
        
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç True –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —É—Ä–æ–≤–Ω–µ–π, —Ç—Ä–µ–±—É—é—â–∏—Ö –≤–Ω–∏–º–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
        INFO –∏ DEBUG –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ –ª–æ–≥–µ –±–µ–∑ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è —Ä–∞–±–æ—Ç—ã.
        """
        return self in (MessageLevel.ERROR, MessageLevel.WARNING)
    
    @property
    def tk_tag(self) -> str:
        """
        –¢–µ–≥ –¥–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –≤ Tkinter Text –≤–∏–¥–∂–µ—Ç–µ.
        
        –≠—Ç–∏ —Ç–µ–≥–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –≤ MainWindow —Å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º–∏ —Ü–≤–µ—Ç–∞–º–∏:
            - debug: —Å–µ—Ä—ã–π
            - info: —Å–∏–Ω–∏–π
            - success: –∑–µ–ª—ë–Ω—ã–π
            - warning: –æ—Ä–∞–Ω–∂–µ–≤—ã–π
            - error: –∫—Ä–∞—Å–Ω—ã–π
        """
        return {
            MessageLevel.DEBUG: "debug",
            MessageLevel.INFO: "info",
            MessageLevel.SUCCESS: "success",
            MessageLevel.WARNING: "warning",
            MessageLevel.ERROR: "error",
        }[self]


@dataclass(frozen=True)
class AppMessage:
    """
    –ù–µ–∏–∑–º–µ–Ω—è–µ–º–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –º–µ–∂–¥—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
    
    –°–æ–¥–µ—Ä–∂–∏—Ç –≤—Å—é –Ω–µ–æ–±—Ö–æ–¥–∏–º—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è:
    —Ç–µ–∫—Å—Ç, —É—Ä–æ–≤–µ–Ω—å –≤–∞–∂–Ω–æ—Å—Ç–∏, –∏—Å—Ç–æ—á–Ω–∏–∫ –∏ –≤—Ä–µ–º–µ–Ω–Ω—É—é –º–µ—Ç–∫—É.
    
    –ê—Ç—Ä–∏–±—É—Ç—ã:
        text: –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è (plain text)
        level: –£—Ä–æ–≤–µ–Ω—å –≤–∞–∂–Ω–æ—Å—Ç–∏ (–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ü–≤–µ—Ç –∏ –ø–æ–≤–µ–¥–µ–Ω–∏–µ)
        timestamp: –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è (–∞–≤—Ç–æ—É—Å—Ç–∞–Ω–æ–≤–∫–∞)
        source: –ò–º—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞-–æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
    
    –ü—Ä–∏–º–µ—Ä—ã —Å–æ–∑–¥–∞–Ω–∏—è:
        >>> AppMessage.success("–§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω—ë–Ω", source="FileManager")
        >>> AppMessage.warning("–ù–µ –Ω–∞–π–¥–µ–Ω —Ñ–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏", source="ConfigLoader")
        >>> AppMessage.error("–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏", source="DiskWriter")
    """
    text: str
    level: MessageLevel = MessageLevel.INFO
    timestamp: datetime = None
    source: Optional[str] = None
    
    def __post_init__(self):
        """–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω—É—é –º–µ—Ç–∫—É, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ –±—ã–ª–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∞."""
        if self.timestamp is None:
            object.__setattr__(self, 'timestamp', datetime.now())

    @classmethod
    def success(cls, text: str, source: str = None) -> 'AppMessage':
        """
        –°–æ–∑–¥–∞—ë—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏.
        
        Args:
            text: –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
            source: –ò—Å—Ç–æ—á–Ω–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏—è (–æ–±—ã—á–Ω–æ __class__.__name__)
        
        Returns:
            AppMessage —Å —É—Ä–æ–≤–Ω–µ–º SUCCESS
        """
        return cls(text, MessageLevel.SUCCESS, source=source)

    @classmethod
    def info(cls, text: str, source: str = None) -> 'AppMessage':
        """
        –°–æ–∑–¥–∞—ë—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ö–æ–¥–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è.
        
        Args:
            text: –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
            source: –ò—Å—Ç–æ—á–Ω–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏—è
        
        Returns:
            AppMessage —Å —É—Ä–æ–≤–Ω–µ–º INFO
        """
        return cls(text, MessageLevel.INFO, source=source)
    
    @classmethod
    def warning(cls, text: str, source: str = None) -> 'AppMessage':
        """
        –°–æ–∑–¥–∞—ë—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –Ω–µ—à—Ç–∞—Ç–Ω–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏.
        
        Args:
            text: –¢–µ–∫—Å—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
            source: –ò—Å—Ç–æ—á–Ω–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏—è
        
        Returns:
            AppMessage —Å —É—Ä–æ–≤–Ω–µ–º WARNING (–≤—ã–∑—ã–≤–∞–µ—Ç –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ –æ–∫–Ω–æ)
        """
        return cls(text, MessageLevel.WARNING, source=source)
    
    @classmethod
    def error(cls, text: str, source: str = None) -> 'AppMessage':
        """
        –°–æ–∑–¥–∞—ë—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ.
        
        Args:
            text: –û–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏
            source: –ò—Å—Ç–æ—á–Ω–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏—è
        
        Returns:
            AppMessage —Å —É—Ä–æ–≤–Ω–µ–º ERROR (–≤—ã–∑—ã–≤–∞–µ—Ç –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ –æ–∫–Ω–æ)
        """
        return cls(text, MessageLevel.ERROR, source=source)
    
    @classmethod
    def debug(cls, text: str, source: str = None) -> 'AppMessage':
        """
        –°–æ–∑–¥–∞—ë—Ç –æ—Ç–ª–∞–¥–æ—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤.
        
        Args:
            text: –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
            source: –ò—Å—Ç–æ—á–Ω–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏—è
        
        Returns:
            AppMessage —Å —É—Ä–æ–≤–Ω–µ–º DEBUG (–Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ)
        """
        return cls(text, MessageLevel.DEBUG, source=source)
    
    @property
    def formatted(self) -> str:
        """
        –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –≤—ã–≤–æ–¥–∞ –≤ –∫–æ–Ω—Å–æ–ª—å –∏–ª–∏ –ª–æ–≥-—Ñ–∞–π–ª.
        
        –§–æ—Ä–º–∞—Ç: "HH:MM:SS PREFIX[source]: text"
        –ü—Ä–∏–º–µ—Ä: "14:25:33 ‚úÖ SUCCESS[FileManager]: –§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω—ë–Ω"
        
        Returns:
            str: –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        """
        time_str = self.timestamp.strftime("%H:%M:%S")
        source_str = f"[{self.source}]" if self.source else ""
        return f"{time_str} {self.level.prefix}{source_str}: {self.text}"
    
    @property
    def plain_text(self) -> str:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –±–µ–∑ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –º–µ—Ç–∫–∏ –∏ –ø—Ä–µ—Ñ–∏–∫—Å–æ–≤.
        
        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤–æ –≤—Å–ø–ª—ã–≤–∞—é—â–∏—Ö –æ–∫–Ω–∞—Ö, –≥–¥–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
        –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è —Å–∞–º–∏–º –æ–∫–Ω–æ–º.
        
        Returns:
            str: –ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
        """
        return self.text
    
    def __str__(self) -> str:
        """–°—Ç—Ä–æ–∫–æ–≤–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ª–æ–≥."""
        return self.formatted